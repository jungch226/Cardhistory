<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>법인카드 내역</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/polyfills.umd.min.js"></script>
  <style>
    #previewBox {
      width: 100%; max-width: 300px; height: 180px;
      border: 2px dashed #ced4da; border-radius: 8px;
      display: flex; justify-content: center; align-items: center;
      background-color: #f8f9fa; color: #6c757d;
      overflow: hidden; margin-top: 0.5rem;
    }
    #previewBox img {
      max-width: 100%; max-height: 100%; object-fit: contain;
      border-radius: 6px; display: none;
    }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="text-center mb-4">법인카드 내역</h2>

  <form id="cardForm" onsubmit="event.preventDefault(); addRecord();" class="mx-auto" style="max-width:480px;">
    <!-- 입력 폼 (사용자/내역/프로젝트/날짜/사진 업로드) -->
    <div class="mb-3">
      <label for="user" class="form-label">사용자</label>
      <select id="user" class="form-select" required onchange="saveSelectedUser()">
        <option value="">선택하세요</option>
        <option>김동혁</option><option>신경용</option><option>정재원</option>
        <option>이주홍</option><option>정채호</option><option>김현재</option>
        <option>조성원</option><option>문성인</option><option>현혜영</option>
        <option>변지호</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="desc" class="form-label">내역</label>
      <input type="text" id="desc" class="form-control" placeholder="예: 식비(정채호)" required>
    </div>
    <div class="mb-3">
      <label for="pro" class="form-label">프로젝트</label>
      <input type="text" id="pro" class="form-control" placeholder="예: 순천 POSCO 형상 모니터링" required>
    </div>
    <div class="mb-3">
      <label for="date" class="form-label">날짜</label>
      <input type="date" id="date" class="form-control" required>
    </div>
    <div class="mb-3">
      <button type="button" class="btn btn-primary" onclick="showChoice()">사진 업로드11</button>
      <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="previewImage(event)">
      <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="previewImage(event)">
      <div id="previewBox" class="mt-2">
        <span id="previewText">이미지 미리보기</span><br>
        <img id="preview" alt="미리보기">
      </div>
    </div>
    <div class="d-grid gap-2">
      <button class="btn btn-success" type="submit">내역 추가</button>
      <button class="btn btn-secondary" type="button" onclick="sendAllMail()">공유하기</button>
      <button class="btn btn-danger" type="button" onclick="clearHistory()">히스토리 초기화</button>
    </div>
  </form>

  <hr/>
  <div id="historyList" class="mt-3" style="max-width:480px; margin:0 auto;"></div>
</div>

<script>
let db, base64ImageData = "";

function saveSelectedUser() {
  const user = document.getElementById('user').value;
  localStorage.setItem('selectedUser', user);
}

function openDB() {
  return new Promise((res, rej) => {
    const rq = indexedDB.open('CardDB', 1);
    rq.onerror = () => rej('DB 오류');
    rq.onsuccess = e => { db = e.target.result; res(); };
    rq.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains('cards'))
        db.createObjectStore('cards', { keyPath: 'id', autoIncrement: true });
    };
  });
}

function showChoice() {
  if (confirm("카메라로 촬영하시겠습니까?\n취소하면 앨범에서 선택됩니다.")) {
    document.getElementById('cameraInput').click();
  } else {
    document.getElementById('galleryInput').click();
  }
}

function previewImage(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const img = document.getElementById('preview');
    img.src = ev.target.result;
    img.style.display = 'block';
    document.getElementById('previewText').style.display = 'none';
    base64ImageData = ev.target.result;
  };
  reader.readAsDataURL(file);
}

async function addRecord() {
  const user = user.value, desc = desc.value, pro = pro.value, date = date.value;
  if(!user||!desc||!pro||!date){alert("모든 항목을 입력해주세요.");return;}

  localStorage.setItem('selectedUser', user);
  const rec = { user, desc, pro, date, photo: base64ImageData || "" };
  const tx = db.transaction('cards', 'readwrite');
  tx.objectStore('cards').add(rec);
  tx.oncomplete = () => {
    cardForm.reset();
    user.value = user; desc.value = desc; pro.value = pro; date.value = date;
    base64ImageData = ""; preview.style.display = 'none'; previewText.style.display = 'block';
    renderHistory();
  };
  tx.onerror = () => alert("저장 실패");
}

function getAllRecords() {
  return new Promise((res, rej) => {
    const tx = db.transaction('cards','readonly'),
          rq = tx.objectStore('cards').getAll();
    rq.onsuccess = () => res(rq.result);
    rq.onerror = () => rej('조회 실패');
  });
}

async function renderHistory() {
  const list = historyList; list.innerHTML="";
  try {
    const history = await getAllRecords();
    history.forEach(r => {
      const w= document.createElement('div');
      w.className="border p-2 mb-2 d-flex justify-content-between";
      const left = document.createElement('div'),
            img = `<img src="${r.photo}" style="max-width:100px;max-height:80px;margin-top:5px;">`;
      left.innerHTML = `<b>${r.user}</b> (${r.date})<br>내역: ${r.desc}<br>프로젝트: ${r.pro}<br>${img}`;
      const btn = document.createElement('button');
      btn.className="btn btn-sm btn-danger";
      btn.textContent="삭제";
      btn.onclick = () => deleteRecord(r.id);
      w.append(left, btn);
      list.appendChild(w);
    });
  } catch(e) { alert("히스토리 로드 실패"); }
}

function deleteRecord(id) {
  if (!confirm("삭제하시겠습니까?")) return;
  const tx = db.transaction('cards','readwrite');
  tx.objectStore('cards').delete(id);
  tx.oncomplete = renderHistory;
  tx.onerror = () => alert("삭제 실패");
}

async function clearHistory() {
  if (!confirm("모두 삭제하시겠습니까?")) return;
  const tx = db.transaction('cards','readwrite');
  tx.objectStore('cards').clear();
  tx.oncomplete = renderHistory;
  tx.onerror = () => alert("초기화 실패");
}

async function sendAllMail() {
  await exportPDF();
}

async function exportPDF() {
  const history = await getAllRecords();
  if(history.length===0){ alert("내역이 없습니다."); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const pw = doc.internal.pageSize.getWidth(),
        ph = doc.internal.pageSize.getHeight();
  let y=10;

  history.forEach(r=>{
    if(r.photo){
      try{ doc.addImage(r.photo, 'JPEG', 10, y, 90, 60); }
      catch{}
    }
    y += 64;
    doc.setFontSize(10);
    [`사용자: ${r.user}`, `날짜: ${r.date}`, `내역: ${r.desc}`, `프로젝트: ${r.pro}`]
      .forEach(line=>{
        if(y+6>ph-10){ doc.addPage(); y=10; }
        doc.text(line, 10, y); y+=6;
      });
    y+=10;
    if(y+60>ph-10){ doc.addPage(); y=10; }
  });

  const now=new Date();
  const fn = `법인카드내역_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}.pdf`;
  const blob = doc.output("blob");
  const file = new File([blob], fn, { type: "application/pdf" });

  if(navigator.canShare && navigator.canShare({ files: [file] })) {
    try{ await navigator.share({ files:[file], title:"법인카드 내역" }); }
    catch{ alert("공유 실패"); }
  } else {
    doc.save(fn);
    alert(`${fn} 저장되었습니다. 이메일에 첨부해주세요.`);
  }
}

window.onload = async()=>{
  await openDB();
  if(localStorage.selectedUser) user.value = localStorage.selectedUser;
  desc.value = localStorage.wdesc||"";
  pro.value = localStorage.wpro||"";
  date.value = new Date().toISOString().split("T")[0];
  renderHistory();
};
</script>
</body>
</html>
