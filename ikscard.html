<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>법인카드 내역</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    #previewBox { width:100%; max-width:300px; height:180px; border:2px dashed #ced4da;
      border-radius:8px; display:flex; justify-content:center; align-items:center;
      background:#f8f9fa; color:#6c757d; overflow:hidden; margin-top:0.5rem; }
    #previewBox img { max-width:100%; max-height:100%; object-fit:contain; display:none; border-radius:6px; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="text-center mb-4">법인카드 내역</h2>
  <form id="cardForm" onsubmit="event.preventDefault(); addRecord();" class="mx-auto" style="max-width:480px;">
    <div class="mb-3">
      <label class="form-label">사용자</label>
      <select id="user" class="form-select" required>
        <option value="">선택하세요</option>
        <option>김동혁</option><option>신경용</option><option>정재원</option>
        <option>이주홍</option><option>정채호</option><option>김현재</option>
        <option>조성원</option><option>문성인</option><option>현혜영</option><option>변지호</option>
      </select>
    </div>
    <div class="mb-3"><label class="form-label">내역</label><input type="text" id="desc" class="form-control" required></div>
    <div class="mb-3"><label class="form-label">프로젝트</label><input type="text" id="pro" class="form-control" required></div>
    <div class="mb-3"><label class="form-label">날짜</label><input type="date" id="date" class="form-control" required></div>
    <div class="mb-3">
      <button type="button" class="btn btn-primary" onclick="document.getElementById('photo').click()">사진 업로드</button>
      <input type="file" id="photo" accept="image/*" style="display:none" onchange="previewImage(event)">
      <div id="previewBox" class="mt-2"><span id="previewText">이미지 미리보기</span><img id="preview"></div>
    </div>
    <div class="d-grid gap-2">
      <button class="btn btn-success" type="submit">내역 추가</button>
      <button class="btn btn-secondary" type="button" onclick="shareZip()">ZIP 공유</button>
    </div>
  </form>
  <hr/>
  <div id="historyList" class="mt-3" style="max-width:480px; margin:0 auto;"></div>
</div>
<script>
let records = [], photoData = "";
function previewImage(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    photoData = ev.target.result;
    preview.src = photoData;
    preview.style.display = 'block'; previewText.style.display = 'none';
  };
  r.readAsDataURL(f);
}
function addRecord() {
  const user = user.value, desc = desc.value, pro = pro.value, date = date.value;
  if (!user || !desc || !pro || !date) return alert("모든 항목을 입력하세요.");
  records.push({ user, desc, pro, date, photo: photoData });
  preview.src = ""; preview.style.display = "none"; previewText.style.display = "block";
  cardForm.reset(); renderHistory();
}
function renderHistory() {
  historyList.innerHTML = records.map((r, i) => `
    <div class='border p-2 mb-2'><b>${r.user}</b> (${r.date})<br>${r.desc}<br>${r.pro}</div>`).join("");
}
async function shareZip() {
  if (!records.length) return alert("내역이 없습니다.");
  const zip = new JSZip();
  const txt = records.map(r => `사용자: ${r.user}\n날짜: ${r.date}\n내역: ${r.desc}\n프로젝트: ${r.pro}\n`).join("\n");
  zip.file("cards.txt", txt);
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 10;
  for (let r of records) {
    if (r.photo) try {
      pdf.addImage(r.photo, 'JPEG', 10, y, 90, 60);
      y += 70; if (y > 270) { pdf.addPage(); y = 10; }
    } catch {}
  }
  const pdfBlob = pdf.output("blob");
  zip.file("photos.pdf", pdfBlob);
  const blob = await zip.generateAsync({ type: "blob" });
  const zipFile = new File([blob], "카드내역_" + new Date().toISOString().slice(0,10) + ".zip", { type: "application/zip" });
  if (navigator.canShare && navigator.canShare({ files: [zipFile] })) {
    try { await navigator.share({ files: [zipFile], title: "법인카드 ZIP" }); }
    catch { alert("공유 취소됨"); }
  } else {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = zipFile.name;
    a.click();
  }
}
</script>
</body>
</html>
